<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì„¸ì…˜ ì¤€ë¹„ ì‘ì—…ê¸°</title>

<style>
body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: #e9ebee; color: #333; padding: 20px; line-height: 1.5; }
textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
.input-group { margin: 15px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
.name-input { width: 120px; }
.josa-label { font-size: 12px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 3px; }

.batchim-group { display: none; gap: 2px; background: #ddd; padding: 2px; border-radius: 4px; }
.batchim-btn { padding: 4px 8px; font-size: 11px; border: none; background: #eee; cursor: pointer; color: #666; border-radius: 2px; }
.batchim-btn.active { background: #5bc0de; color: white; font-weight: bold; }

button.main-btn { padding: 10px 16px; background-color: #5bc0de; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
button.main-btn:hover { background-color: #31b0d5; }

.sentence-container { max-height: 300px; overflow-y: auto; margin-bottom: 10px; border: 1px dashed #bbb; padding: 5px; }
.sentence { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; background: #fff; padding: 8px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.sentence span { flex: 1; font-size: 14px; color: #444; outline: none; border-bottom: 1px solid transparent; }
.sentence span:focus { background: #fffde7; border-bottom: 1px solid #ffeb3b; }
.npc-input { width: 80px; padding: 4px; font-size: 12px; display: none; }
.scroll-box { background: #fff; border: 1px solid #ddd; padding: 15px; height: 450px; overflow-y: auto; border-radius: 4px; }
.output { background: #1a1a1a; color: #d4d4d4; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.4; word-break: break-all; }
.preview { background: #f3f3f3; }
.r20-desc { background: #ffffff; border: 1px solid #ccc; padding: 8px; margin-bottom: 5px; border-radius: 3px; color: #000; font-size: 13px; }
.r20-judge { text-decoration: none; font-size:12px; text-align: center; display: inline-block; color: white; text-shadow: 0px 0px 5px #000; letter-spacing: -1px; padding: 5px 40px; border-radius: 20px; border: 1px solid #FFFFFF; box-shadow: 0 0 2px 1px #8f8f8f; margin: 10px 0; }
.r20-emas { font-style: italic; color: #2c3e50; margin-bottom: 8px; padding-left: 5px; font-size: 13px; }
.r20-as { margin-bottom: 10px; font-size: 13px; }
.r20-as-name { font-weight: bold; margin-right: 5px; }
.copy-btn { background: #5cb85c; margin-bottom: 10px; width: 100%; }
.copy-btn:hover { background: #449d44; }
.flex-row { display: flex; gap: 20px; margin-top: 10px; }
.flex-col { flex: 1; min-width: 0; }
</style>
</head>
<body>

<h2>ğŸ² ì„¸ì…˜ ì¤€ë¹„ ì‘ì—…ê¸°</h2>

<textarea id="input" placeholder="ì—¬ê¸°ì— ì‹œë‚˜ë¦¬ì˜¤ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

<div class="input-group">
  KPC: <input id="kpcName" class="name-input" placeholder="KPC ì´ë¦„" value="">
  <label class="josa-label"><input type="checkbox" id="kpcJosaToggle" onchange="toggleBatchimGroup('kpc')"> ì¡°ì‚¬ì„ íƒ</label>
  <div id="kpcBatchimGroup" class="batchim-group">
    <button class="batchim-btn" id="kpc-O" onclick="setBatchim('kpc', true)">ë°›ì¹¨O</button>
    <button class="batchim-btn" id="kpc-X" onclick="setBatchim('kpc', false)">ë°›ì¹¨X</button>
  </div>
  
  PC: <input id="pcName" class="name-input" placeholder="PC ì´ë¦„" value="">
  <label class="josa-label"><input type="checkbox" id="pcJosaToggle" onchange="toggleBatchimGroup('pc')"> ì¡°ì‚¬ì„ íƒ</label>
  <div id="pcBatchimGroup" class="batchim-group">
    <button class="batchim-btn" id="pc-O" onclick="setBatchim('pc', true)">ë°›ì¹¨O</button>
    <button class="batchim-btn" id="pc-X" onclick="setBatchim('pc', false)">ë°›ì¹¨X</button>
  </div>
  
  <button class="main-btn" onclick="splitSentences()">ë¬¸ì¥ ë‚˜ëˆ„ê¸° (ì¹˜í™˜ ì ìš©)</button>
</div>

<div id="sentenceArea" class="sentence-container"></div>

<button onclick="convert()" style="width:100%; margin-top:10px; background:#4a4a4a; height: 45px; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ì ìš© ë° ë³€í™˜</button>

<div class="flex-row">
  <div class="flex-col">
    <h3>ğŸ“‹ Roll20 ë³µì‚¬ìš©</h3>
    <button class="copy-btn" onclick="copyResult()">ì „ì²´ ì½”ë“œ ë³µì‚¬</button>
    <div class="scroll-box output" id="output"></div>
  </div>
  
  <div class="flex-col">
    <h3>ğŸ‘ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</h3>
    <div style="height: 38px; margin-bottom: 10px;"></div>
    <div class="scroll-box preview" id="preview"></div>
  </div>
</div>

<script>
let batchimState = {
  kpc: null, 
  pc: null
};

const styles = {
  ê¸°ë³¸: { roll: (t) => `/desc [${t}](#" style="color:#000000; text-decoration:none;)`, previewClass: "r20-desc", css: () => `color:#000000;` },
  NPC: { roll: (t, n) => `/as "${n || "NPC"}" ${t}`, previewClass: "r20-as", css: () => `` },
  ì±•í„°: { roll: (t) => `/desc [${t}](#" style="text-decoration:none; color:#333333; font-size:16px; font-style: normal; font-weight: normal; text-align:right; display:block;)`, previewClass: "r20-desc", css: () => `text-decoration:none; color:#333333; font-size:16px; text-align:right; display:block;` },
  emas: { roll: (t) => `/emas "" ${t}`, previewClass: "r20-emas", css: () => `` },
  íŒì •: { roll: (t, c1, c2) => `/desc [${t}](#" style=" text-decoration: none; font-size:12px; font-style: normal !important; text-align: center; display: inline-block; color: white; text-shadow: 0px 0px 5px #000; letter-spacing: -1px; padding: 5px 40px; margin-left: -4px; border-radius: 20px; border: 1px solid #FFFFFF; box-shadow: 0 0 2px 1px #8f8f8f; background-image: linear-gradient(90deg, ${c1} 0%, ${c2} 100%)`, previewClass: "r20-judge", css: (c1, c2) => `background-image: linear-gradient(90deg, ${c1} 0%, ${c2} 100%);` },
  ë°°ê²½ìƒ‰: { 
    roll: (t, c1, c2) => `/desc [${t}](#" style="text-decoration:none; color:${c1}; background-color:${c2}; text-align:center; display:block; padding:2px; box-shadow: 0px 8px 0px 15px ${c2};)`, 
    previewClass: "r20-desc", 
    css: (c1, c2) => `color:${c1}; background-color:${c2}; text-align:center; display:block; padding:10px; margin: 15px 0;` 
  },
  ìƒ¤ë°©: { roll: (t) => `/desc [${t}](#" style=" text-decoration: none; color:white;font-size:15px;text-shadow:3px 0px 6px #FE2E64,-5px 0px 10px #F5BCA9)`, previewClass: "r20-desc", css: () => `color:white; font-size:15px; text-shadow:2px 0px 5px #FE2E64; background:#FE2E64; padding:2px 4px; border-radius:3px;` },
  ê¸€ë¦¬ì¹˜: { roll: (t) => `/desc [${t}](#" style=" text-decoration: none; color:#000000;text-shadow:1px 3px 2px #ff0000,2px 1px 2px #0100ff,5px 1px 0px #40FF00)`, previewClass: "r20-desc", css: () => `text-shadow:1px 2px 2px #ff0000, 2px 1px 2px #0100ff;` },
  í°ê¸€ì”¨: { roll: (t) => `/desc [${t}](" style="text-decoration:none;  color:#000000; font-size:20px;font-weight:bold;text-align:center;display:block;)`, previewClass: "r20-desc", css: () => `font-size:18px; font-weight:bold; text-align:center; display:block;` },
  ê¶ì„œì²´: { roll: (t) => `/desc [${t}](#" style="text-decoration:none; font-family:cursive;font-style:italic;color:red;text-align:center;display:block;)`, previewClass: "r20-desc", css: () => `font-family:serif; font-style:italic; color:red; text-align:center; display:block;` },
  ìƒ‰ìƒ: { roll: (t, c) => `/desc [${t}](#" style="text-decoration:none; font-weight:bold; color:${c};)`, previewClass: "r20-desc", css: (c) => `color:${c}; font-weight:bold;` }
};

function toggleBatchimGroup(type) {
  const isChecked = document.getElementById(type + 'JosaToggle').checked;
  const group = document.getElementById(type + 'BatchimGroup');
  group.style.display = isChecked ? 'flex' : 'none';
  
  if (isChecked && batchimState[type] === null) {
    const name = document.getElementById(type + 'Name').value;
    setBatchim(type, hasBatchim(name));
  }
}

function setBatchim(type, status) {
  batchimState[type] = status;
  
  document.getElementById(`${type}-O`).classList.toggle('active', status === true);
  document.getElementById(`${type}-X`).classList.toggle('active', status === false);
  
  if (document.querySelectorAll('.sentence').length > 0) {
    convert(); 
  }
}

function hasBatchim(name) {
  if (!name) return false;
  const lastChar = name.charCodeAt(name.length - 1);
  if (lastChar < 0xAC00 || lastChar > 0xD7A3) return false;
  return (lastChar - 0xAC00) % 28 > 0;
}

function getCorrectJosa(name, josa, forcedBatchim) {
  const batchim = (forcedBatchim !== null) ? forcedBatchim : hasBatchim(name);
  if (josa === "ì´ê°€") return batchim ? "ì´" : "ê°€";
  if (["ì€", "ëŠ”"].includes(josa)) return batchim ? "ì€" : "ëŠ”";
  if (["ì´", "ê°€"].includes(josa)) return batchim ? "ì´" : "ê°€";
  if (["ì„", "ë¥¼"].includes(josa)) return batchim ? "ì„" : "ë¥¼";
  return josa;
}

function replaceWithJosa(text, targetPattern, name, type) {
  const isJosaEnabled = document.getElementById(type + 'JosaToggle').checked;
  const forcedBatchim = batchimState[type];

  if (!isJosaEnabled) return text.replace(new RegExp(targetPattern, 'gi'), name);

  const josaRegex = new RegExp(`${targetPattern}(ì€|ëŠ”|ì„|ë¥¼|ì´ê°€|ì´|ê°€)`, 'gi');
  text = text.replace(josaRegex, (match, josa) => name + getCorrectJosa(name, josa, forcedBatchim));
  
  return text.replace(new RegExp(targetPattern, 'gi'), name);
}

function replaceNames(text) {
  const kpcName = document.getElementById("kpcName").value || "KPC";
  const pcName = document.getElementById("pcName").value || "PC";

  let replaced = text;
  replaced = replaceWithJosa(replaced, "KPC", kpcName, 'kpc');
  replaced = replaceWithJosa(replaced, "PC", pcName, 'pc');
  replaced = replaceWithJosa(replaced, "íƒì‚¬ì", pcName, 'pc');
  return replaced;
}

function handleStyleChange(select) {
  const row = select.parentElement;
  const color1 = row.querySelector('.color1');
  const color2 = row.querySelector('.color2');
  const npcInput = row.querySelector('.npc-input');
  color1.style.display = (["ìƒ‰ìƒ", "íŒì •", "ë°°ê²½ìƒ‰"].includes(select.value)) ? "inline-block" : "none";
  color2.style.display = (["íŒì •", "ë°°ê²½ìƒ‰"].includes(select.value)) ? "inline-block" : "none";
  npcInput.style.display = (select.value === "NPC") ? "inline-block" : "none";
}

function splitSentences() {
  const area = document.getElementById("sentenceArea");
  area.innerHTML = "";
  const rawInput = document.getElementById("input").value.trim();
  if (!rawInput) return;

  const processedText = replaceNames(rawInput);
  const sentences = processedText.match(/("[^"]*"|.+?([.!?]+|\n|$)|[.!?]+)/g)
    .map(s => s.trim())
    .filter(s => s.length > 0);

  sentences.forEach(sentence => {
    const row = document.createElement("div");
    row.className = "sentence";
    
    const span = document.createElement("span");
    span.textContent = sentence;
    span.contentEditable = true;

    const npcInput = document.createElement("input");
    npcInput.className = "npc-input";
    npcInput.placeholder = "NPC ì´ë¦„";

    const select = document.createElement("select");
    select.onchange = () => handleStyleChange(select);
    Object.keys(styles).forEach(k => {
      const o = document.createElement("option");
      o.value = k; o.textContent = k;
      select.appendChild(o);
    });

    const color1 = document.createElement("input");
    color1.type = "color"; color1.className = "color1"; color1.value = "#000000"; color1.style.display = "none";
    
    const color2 = document.createElement("input");
    color2.type = "color"; color2.className = "color2"; color2.value = "#ffffff"; color2.style.display = "none";

    row.appendChild(span);
    row.appendChild(npcInput);
    row.appendChild(select);
    row.appendChild(color1);
    row.appendChild(color2);
    area.appendChild(row);
  });
}

function convert() {
  const rows = document.querySelectorAll(".sentence");
  const out = [];
  const prev = [];

  rows.forEach(row => {
    const text = row.querySelector("span").textContent; 
    
    const styleKey = row.querySelector("select").value;
    const npcName = row.querySelector(".npc-input").value;
    const c1 = row.querySelector(".color1").value;
    const c2 = row.querySelector(".color2").value;
    const style = styles[styleKey];

    if (styleKey === "ìƒ‰ìƒ") {
      out.push(style.roll(text, c1));
      prev.push(`<div class="${style.previewClass}" style="${style.css(c1)}">${text}</div>`);
    } else if (styleKey === "íŒì •" || styleKey === "ë°°ê²½ìƒ‰") {
      out.push(style.roll(text, c1, c2));
      prev.push(`<div class="${style.previewClass}" style="${style.css(c1, c2)}">${text}</div>`);
    } else if (styleKey === "NPC") {
      out.push(style.roll(text, npcName));
      prev.push(`<div class="${style.previewClass}"><span class="r20-as-name">${npcName || "NPC"}:</span><span>${text}</span></div>`);
    } else {
      out.push(style.roll(text));
      prev.push(`<div class="${style.previewClass}" style="${style.css ? style.css() : ''}">${text}</div>`);
    }
  });

  document.getElementById("output").textContent = out.join("\n");
  document.getElementById("preview").innerHTML = prev.join("");
}

function copyResult() {
  const text = document.getElementById("output").textContent;
  if(!text) return;
  navigator.clipboard.writeText(text);
  const btn = document.querySelector(".copy-btn");
  btn.textContent = "âœ” ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!";
  setTimeout(() => btn.textContent = "ì „ì²´ ì½”ë“œ ë³µì‚¬", 1000);
}
</script>
</body>
</html>
